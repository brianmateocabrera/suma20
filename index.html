<!doctype html>

<html lang="es">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Suma 20</title>
        <link
            href="https://fonts.googleapis.com/css2?family=Great+Vibes&display=swap"
            rel="stylesheet"
        />
        <style>
            /* === Reseteo y Estilos Generales === */
            html,
            body {
                margin: 0;
                padding: 0;
                height: 100%;
                overflow: hidden;
                font-family: "Segoe UI", sans-serif;
                color: #004400;
            }

            /* === Fondo de Pantalla === */
            #fondo {
                position: absolute;
                inset: 0;
                width: 100vw;
                height: 100vh;
                background: radial-gradient(circle, #006400, #003300);
                z-index: 0;
            }

            /* === Capas === */
            #capa-cartas {
                position: absolute;
                inset: 0;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                z-index: 1;
            }

            /* === Estilos de Cartas === */
            .card,
            .card-back {
                width: clamp(80px, 10vh, 80px);
                aspect-ratio: 10 / 16;
                border-radius: clamp(6px, 1.5vh, 12px);
                box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.4);
            }

            .card {
                border: clamp(3px, 1vw, 10px) solid black;
                background: white;
                display: flex;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                font-size: clamp(24px, 15vw, 80px);
                font-weight: bold;
                margin: clamp(3px, 1vh, 10px) 0 0;
                transition: transform 0.3s;
                user-select: none;
            }

            .card:hover {
                transform: scale(1.05);
            }

            .card.selected {
                outline: clamp(2px, 0.5vh, 4px) solid gold;
                transform: scale(1.1);
            }

            .card-back {
              display:flex;
              flex-direction:column;
              justify-content: center;
              align-items:center;
                border: clamp(3px, 1vw, 10px) solid white;
                background-color: white;background-image:
              repeating-linear-gradient(
                  45deg,
                  grey 0,
                  silver 1px,
                  transparent 1px,
                  transparent 5px
              ),
              repeating-linear-gradient(
                  -45deg,
                  goldenrod 0,
                  gold 1px,
                  transparent 1px,
                  transparent 5px
              );

            }

            .card-back .logo {

                width: 80%;
                height: 18%;
                display: flex;
                align-items: center;
                justify-content: center;
                background-color: rgba(255, 255, 255, 0.85);
                padding: 4px 12px;
                border:none;
                font-family: "Great Vibes", cursive;
                font-size: clamp(12px, 4vh, 24px);
                font-weight:bold;
                color: goldenrod;
                text-align: center;
            }

            /* === Etiquetas de Cuenta === */
            .count-label {
                margin-top: clamp(4px, 0.8vh, 10px);
                font-size: clamp(12px, 2vh, 48px);
                color: white;
            }

            /* === Zona de la Mesa === */
            #tableZone {
                display: flex;
                flex-wrap: wrap;
                justify-content: center;
                gap: clamp(6px, 3vh, 12px);
                width: 100vw;
                max-width: 608px;
                margin: 0 auto;
                z-index: 1;
            }

            h1 {
                position: absolute;
                top: 25%;
                left: 50%;
                transform: translate(-50%, -50%);
                font-family: "Great Vibes", cursive;
                font-size: clamp(48px, 15vw, 120px);
                z-index: 0;
            }

            p {
                font-size: clamp(16px, 2vh, 48px);
                margin: clamp(2px, 0.5vh, 4px) 0;
            }

            /* === Barra Superior de UI === */
            #ui {
                position: absolute;
                top: 0;
                left: 50%;
                transform: translateX(-50%);
                width: 100%;
                max-width: 608px;
                height: clamp(160px, 22vh, 300px);
                z-index: 2;
                color: white;
                background: rgba(0, 0, 0, 0.4);
                padding: clamp(8px, 2vh, 20px) clamp(12px, 3vw, 30px);
                backdrop-filter: blur(4px);
                display: flex;
                justify-content: space-between;
                align-items: center;
                gap: clamp(2px, 1vh, 6px);
                box-sizing: border-box;
            }

            #ui-left,
            #deckZone,
            #discardZone {
                display: flex;
                flex-direction: column;
                gap: clamp(3px, 0.8vh, 6px);
                align-items: left;
            }

            #ui-right {
                display: flex;
                flex-direction: row;
                gap: clamp(3px, 0.8vh, 6px);
            }

            #ui button,
            #boton-nextturn button,
            #btnNuevoJuegoModal {
                border: 2px solid grey;
                cursor: pointer;
                border-radius: clamp(4px, 1.5vh, 8px);
                box-shadow: 2px 2px 10px rgba(0, 0, 0, 0.3)

                font-weight: bold;
                background-color: goldenrod;
                color: black;
            }

            #ui button {
                margin: clamp(3px, 1vh, 6px) 0;
                padding: clamp(6px, 1.8vh, 12px) clamp(12px, 3vw, 20px);
            }

            /* === Botón de Próximo Turno === */
            #boton-nextturn {
                position: absolute;
                bottom: clamp(50px, 5vh, 100px);
                left: 50%;
                transform: translateX(-50%);
                z-index: 3;
            }

            #boton-nextturn button {
                padding: clamp(10px, 2.8vh, 14px) clamp(20px, 5vw, 30px);
            }

            /* === Opciones de Juego === */
            #options {
                display: none;
            }

            /* === Modal de Fin de Juego === */
            #modalOverlay {
                position: fixed;
                inset: 0;
                background: rgba(0, 0, 0, 0.7);
                display: none;
                justify-content: center;
                align-items: center;
                z-index: 5;
            }

            #modalContent {
                background: #fff;
                padding: clamp(20px, 5vh, 30px) clamp(30px, 8vw, 40px);
                border-radius: clamp(8px, 2vh, 15px);
                text-align: center;
                box-shadow: 0 0 20px rgba(0, 0, 0, 0.6);
                max-width: 90vw;
            }

            #modalContent h2 {
                margin-top: 0;
                color: seagreen;
            }

            #btnNuevoJuegoModal {
                margin-top: clamp(12px, 2vh, 20px);
                padding: clamp(10px, 2.4vh, 12px) clamp(20px, 5vw, 28px);
                font-size: clamp(14px, 2.5vh, 18px);
                border-radius: clamp(4px, 1.5vh, 8px);
                animation: blink 1s infinite;
            }

            /* === Animaciones === */
            @keyframes blink {
                0%,
                100% {
                    opacity: 1;
                }
                50% {
                    opacity: 0.5;
                }
            }

            @keyframes puntoAnotado {
                0% {
                    transform: scale(2);
                }
                50% {
                    transform: scale(0.4);
                    color: gold;
                }
                100% {
                    transform: scale(2);
                    color: white;
                }
            }

            #score.animated {
                animation: puntoAnotado 0.5s ease;
            }

            .carta-animada {
                position: absolute;
                transition: transform 0.5s ease;
                z-index: 1000;
                pointer-events: none;
            }
        </style>
    </head>
    <body>
        <!-- Fondo decorativo -->
        <div id="fondo"></div>

        <!-- Interfaz de usuario (UI) principal -->
        <div id="ui">
            <!-- Lado izquierdo: información y controles -->
            <div id="ui-left">
                <button onclick="iniciarJuego()"><p>Nuevo Juego</p></button>
                <p>Puntaje: <span id="score">0</span></p>
                <p>Puntaje Máximo: <span id="max-score">0</span></p>
            </div>

            <!-- Lado derecho: mazo y descarte -->
            <div id="ui-right">
                <div class="zone" id="deckZone"></div>
                <div class="zone" id="discardZone"></div>
            </div>
        </div>

        <!-- Zona central de cartas y opciones -->
        <div id="capa-cartas">
            <div class="zone" id="tableZone"></div>
            <h1>Suma 20</h1>
            <div id="options"></div>
        </div>

        <!-- Botón de acción para siguiente turno -->
        <div id="boton-nextturn">
            <button onclick="nextTurn()"><p>Siguiente carta</p></button>
        </div>

        <!-- Modal de fin de juego -->
        <div id="modalOverlay">
            <div id="modalContent">
                <h2>¡Fin del juego!</h2>
                <p>Puntaje obtenido: <span id="finalScore">0</span></p>
                <button id="btnNuevoJuegoModal" onclick="cerrarModal()">
                    <p>Nuevo Juego</p>
                </button>
            </div>
        </div>
        <script>
            class Carta {
                constructor(valor, color) {
                    this.valor = valor;
                    this.color = color;
                }
            }

            class Mazo {
                constructor(colores, valores) {
                    this.colores = colores;
                    this.valores = valores;
                    this.cartas = [];
                    this.crear();
                    this.mezclar();
                }

                crear() {
                    this.cartas = [];
                    for (let color of this.colores) {
                        for (let valor of this.valores) {
                            this.cartas.push(new Carta(valor, color));
                        }
                    }
                }

                mezclar() {
                    this.cartas.sort(() => Math.random() - 0.5);
                }

                sacarCarta() {
                    return this.cartas.pop();
                }
            }

            class Juego {
                constructor() {
                    this.colores = ["rojo", "azul", "amarillo", "verde"];
                    this.colorMap = {
                        rojo: "firebrick",
                        azul: "royalblue",
                        amarillo: "goldenrod",
                        verde: "seagreen"
                    };
                    this.valores = [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12];

                    this.mazo = new Mazo(this.colores, this.valores);
                    this.mesa = [];
                    this.descarte = [];
                    this.seleccionadas = [];
                    this.puntaje = 0;
                    this.maxPuntaje =
                        parseInt(localStorage.getItem("maxScore")) || 0;

                    this.iniciar();
                }

                iniciar() {
                    this.mazo.crear();
                    this.mazo.mezclar();
                    this.mesa = [];
                    this.descarte = [];
                    this.seleccionadas = [];
                    this.puntaje = 0;
                    this.maxPuntaje =
                        parseInt(localStorage.getItem("maxScore")) || 0;
                    this.actualizarPantalla();
                }

                siguienteTurno() {
                    if (this.mazo.cartas.length === 0) return;

                    const carta = this.mazo.sacarCarta();
                    this.mesa.push(carta);
                    this.actualizarPantalla();

                    setTimeout(() => {
                        const deckZone = document.getElementById("deckZone");
                        const tableZone = document.getElementById("tableZone");
                        const cartaMesa = tableZone.lastElementChild;
                        const cartaMazo = deckZone.querySelector(".card-back");
                        if (cartaMesa && cartaMazo)
                            Juego.animarMovimientoCarta(cartaMazo, cartaMesa);
                    }, 50);

                    this.verificarFinJuego();
                }

                seleccionarCarta(index) {
                    const i = this.seleccionadas.indexOf(index);
                    if (i !== -1) {
                        this.seleccionadas.splice(i, 1);
                    } else {
                        this.seleccionadas.push(index);
                    }
                    this.validarSeleccion();
                    this.actualizarPantalla();
                }

                validarSeleccion() {
                    const seleccionadas = this.seleccionadas.map(
                        i => this.mesa[i]
                    );
                    const suma = seleccionadas.reduce(
                        (acc, c) => acc + c.valor,
                        0
                    );
                    if (suma === 20) {
                        this.aplicarCombinacion([...this.seleccionadas]);
                        this.seleccionadas = [];
                    }
                }

                aplicarCombinacion(indices) {
                    const seleccionadas = indices.map(i => this.mesa[i]);
                    const tableZone = document.getElementById("tableZone");
                    const discardZone = document.getElementById("discardZone");

                    indices.forEach(i => {
                        const elem = tableZone.children[i];
                        if (elem)
                            Juego.animarMovimientoCarta(elem, discardZone);
                    });

                    this.descarte.push(...seleccionadas);
                    this.mesa = this.mesa.filter(
                        (_, i) => !indices.includes(i)
                    );
                    this.seleccionadas = [];

                    if (this.mesa.length === 0) {
                        this.puntaje++;
                        if (this.puntaje > this.maxPuntaje) {
                            this.maxPuntaje = this.puntaje;
                            localStorage.setItem("maxScore", this.maxPuntaje);
                        }
                        const scoreElem = document.getElementById("score");
                        scoreElem.classList.add("animated");
                        setTimeout(
                            () => scoreElem.classList.remove("animated"),
                            600
                        );
                    }

                    this.actualizarPantalla();
                    this.verificarFinJuego();
                }

                verificarFinJuego() {
                    const sinCartas = this.mazo.cartas.length === 0;
                    const sinOpciones =
                        Juego.encontrarCombinaciones(this.mesa).length === 0;

                    if (sinCartas && sinOpciones) {
                        const tableZone = document.getElementById("tableZone");
                        const discardZone =
                            document.getElementById("discardZone");

                        this.mesa.forEach((carta, index) => {
                            const elem = tableZone.children[index];
                            if (elem)
                                Juego.animarMovimientoCarta(elem, discardZone);
                        });

                        this.descarte.push(...this.mesa);
                        this.mesa = [];
                        this.seleccionadas = [];

                        this.actualizarPantalla();

                        setTimeout(() => this.mostrarModalFin(), 600); // Espera que termine la animación
                    }
                }

                mostrarModalFin() {
                    document.getElementById("finalScore").textContent =
                        this.puntaje;
                    document.getElementById("modalOverlay").style.display =
                        "flex";
                }

                cerrarModal() {
                    document.getElementById("modalOverlay").style.display =
                        "none";
                    this.iniciar();
                }

                actualizarPantalla() {
                    Juego.renderZone(
                        "deckZone",
                        this.mazo.cartas,
                        true,
                        "Mazo",
                        this.colorMap
                    );
                    Juego.renderZone(
                        "tableZone",
                        this.mesa,
                        false,
                        "Mesa",
                        this.colorMap,
                        this.seleccionadas,
                        i => this.seleccionarCarta(i)
                    );
                    Juego.renderZone(
                        "discardZone",
                        this.descarte,
                        true,
                        "Descarte",
                        this.colorMap
                    );
                    document.getElementById("score").textContent = this.puntaje;
                    document.getElementById("max-score").textContent =
                        this.maxPuntaje;
                    this.mostrarOpciones();
                }

                mostrarOpciones() {
                    const opciones = Juego.encontrarCombinaciones(this.mesa);
                    const contenedor = document.getElementById("options");
                    contenedor.innerHTML =
                        '<h3 style="color:white;">Opciones:</h3>';

                    if (opciones.length === 0) {
                        contenedor.innerHTML +=
                            '<p style="color:white;">No hay combinaciones disponibles.</p>';
                    } else {
                        opciones.forEach((combo, index) => {
                            const btn = document.createElement("button");
                            btn.textContent = `Opcion ${index + 1}: ${combo
                                .map(i => this.mesa[i].valor)
                                .join(" + ")}`;
                            btn.onclick = () => this.aplicarCombinacion(combo);
                            contenedor.appendChild(btn);
                        });
                    }
                }

                static encontrarCombinaciones(cards, objetivo = 20) {
                    const resultados = [];
                    function buscar(comb, start, suma) {
                        if (suma === objetivo)
                            return resultados.push([...comb]);
                        if (suma > objetivo) return;
                        for (let i = start; i < cards.length; i++) {
                            comb.push(i);
                            buscar(comb, i + 1, suma + cards[i].valor);
                            comb.pop();
                        }
                    }
                    buscar([], 0, 0);
                    return resultados;
                }

                static renderZone(
                    id,
                    cards,
                    back = false,
                    label = "",
                    colorMap = {},
                    seleccionadas = [],
                    onSelect
                ) {
                    const zone = document.getElementById(id);
                    zone.innerHTML = "";

                    if (back && cards.length > 0) {
                        if (id === "discardZone") {
                            zone.appendChild(
                                Juego.renderCard(
                                    cards[cards.length - 1],
                                    colorMap
                                )
                            );
                        } else {
                            const div = document.createElement("div");
                            div.className = "card-back";

                            const logo = document.createElement("div");
                            logo.className = "logo";
                            logo.textContent = "Suma20"; // Cambiá esto si usás una imagen

                            div.appendChild(logo);
                            zone.appendChild(div);
                        }
                    } else {
                        cards.forEach((card, index) => {
                            zone.appendChild(
                                Juego.renderCard(
                                    card,
                                    colorMap,
                                    index,
                                    seleccionadas,
                                    onSelect
                                )
                            );
                        });
                    }

                    if (id !== "tableZone") {
                        const labelDiv = document.createElement("div");
                        labelDiv.className = "count-label";
                        labelDiv.textContent = `${label}: ${cards.length}`;
                        zone.appendChild(labelDiv);
                    }
                }

                static renderCard(
                    card,
                    colorMap,
                    index = null,
                    seleccionadas = [],
                    onSelect
                ) {
                    const div = document.createElement("div");
                    div.className = "card";
                    div.textContent = card.valor;
                    const cssColor = colorMap[card.color];
                    div.style.borderColor = cssColor;
                    div.style.color = cssColor;
                    if (index !== null) {
                        div.dataset.index = index;
                        if (seleccionadas.includes(index))
                            div.classList.add("selected");
                        div.onclick = () => onSelect(index);
                    }
                    return div;
                }

                static animarMovimientoCarta(origen, destino, callback) {
                    const clone = origen.cloneNode(true);
                    const rectO = origen.getBoundingClientRect();
                    const rectD = destino.getBoundingClientRect();

                    clone.classList.add("carta-animada");
                    document.body.appendChild(clone);

                    clone.style.left = `${rectO.left}px`;
                    clone.style.top = `${rectO.top}px`;
                    clone.style.width = `${rectO.width}px`;
                    clone.style.height = `${rectO.height}px`;

                    requestAnimationFrame(() => {
                        clone.style.transform = `translate(${
                            rectD.left - rectO.left
                        }px, ${rectD.top - rectO.top}px)`;
                    });

                    setTimeout(() => {
                        document.body.removeChild(clone);
                        if (callback) callback();
                    }, 500);
                }
            }

            // Inicialización global
            let juego;
            function iniciarJuego() {
                juego = new Juego();
            }

            function nextTurn() {
                juego.siguienteTurno();
            }

            function cerrarModal() {
                juego.cerrarModal();
            }

            iniciarJuego();
        </script>
    </body>
</html>